name: Instagram DM Automation

on:
  repository_dispatch:
    types: [instagram_fun_fact_comment]
  workflow_dispatch:  # Allow manual testing

jobs:
  send-dm:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        pip install requests python-dotenv
    
    - name: Process Instagram Comments and Send DMs
      env:
        INSTAGRAM_ACCESS_TOKEN: ${{ secrets.INSTAGRAM_ACCESS_TOKEN }}
        INSTAGRAM_PAGE_ID: ${{ secrets.INSTAGRAM_PAGE_ID }}
      run: |
        python -c "
        import requests
        import json
        import os
        from datetime import datetime, timedelta
        
        # Instagram Graph API configuration
        INSTAGRAM_API_BASE = 'https://graph.facebook.com/v18.0'
        access_token = os.getenv('INSTAGRAM_ACCESS_TOKEN')
        page_id = os.getenv('INSTAGRAM_PAGE_ID')
        
        print('üöÄ Starting Instagram DM automation...')
        
        def get_instagram_account_id():
            '''Get the Instagram Business Account ID from the Facebook Page'''
            try:
                url = f'{INSTAGRAM_API_BASE}/{page_id}'
                params = {
                    'access_token': access_token,
                    'fields': 'instagram_business_account'
                }
                response = requests.get(url, params=params)
                data = response.json()
                
                if 'instagram_business_account' in data:
                    instagram_account_id = data['instagram_business_account']['id']
                    print(f'‚úÖ Instagram Account ID: {instagram_account_id}')
                    return instagram_account_id
                else:
                    print('‚ùå No Instagram Business Account found')
                    return None
            except Exception as e:
                print(f'‚ùå Error getting Instagram account ID: {e}')
                return None
        
        def get_recent_comments(instagram_account_id):
            '''Get recent comments from Instagram posts'''
            try:
                # Get recent media
                url = f'{INSTAGRAM_API_BASE}/{instagram_account_id}/media'
                params = {
                    'access_token': access_token,
                    'fields': 'id,caption,timestamp',
                    'limit': 5  # Check last 5 posts
                }
                response = requests.get(url, params=params)
                media_data = response.json()
                
                recent_comments = []
                
                for media in media_data.get('data', []):
                    media_id = media['id']
                    
                    # Get comments for this media
                    comments_url = f'{INSTAGRAM_API_BASE}/{media_id}/comments'
                    comments_params = {
                        'access_token': access_token,
                        'fields': 'id,text,from,timestamp'
                    }
                    comments_response = requests.get(comments_url, params=comments_params)
                    comments_data = comments_response.json()
                    
                    for comment in comments_data.get('data', []):
                        # Check if comment is recent (last 10 minutes)
                        comment_time = datetime.fromisoformat(comment['timestamp'].replace('Z', '+00:00'))
                        if datetime.now().replace(tzinfo=comment_time.tzinfo) - comment_time < timedelta(minutes=10):
                            comment['media_id'] = media_id
                            recent_comments.append(comment)
                
                return recent_comments
                
            except Exception as e:
                print(f'‚ùå Error getting recent comments: {e}')
                return []
        
        def get_fun_fact_for_post(media_id):
            '''Get the fun_fact_followup for a specific Instagram post'''
            try:
                # Load the content queue to find the matching post
                queue_file = 'scheduled_posts/content_queue.json'
                if not os.path.exists(queue_file):
                    return None
                
                with open(queue_file, 'r') as f:
                    queue = json.load(f)
                
                # Find the post by Instagram media ID
                for item in queue:
                    posting_results = item.get('posting_results', {})
                    instagram_result = posting_results.get('instagram', {})
                    
                    if isinstance(instagram_result, dict) and instagram_result.get('id') == media_id:
                        return item.get('fun_fact_followup', '')
                
                return None
                
            except Exception as e:
                print(f'‚ùå Error getting fun fact for post {media_id}: {e}')
                return None
        
        def send_dm(instagram_account_id, user_id, message):
            '''Send a direct message to a user'''
            try:
                url = f'{INSTAGRAM_API_BASE}/{instagram_account_id}/messages'
                data = {
                    'recipient': {'id': user_id},
                    'message': {'text': message},
                    'access_token': access_token
                }
                
                response = requests.post(url, json=data)
                result = response.json()
                
                if response.status_code == 200:
                    print(f'‚úÖ DM sent to user {user_id}')
                    return True
                else:
                    print(f'‚ùå Failed to send DM: {result}')
                    return False
                    
            except Exception as e:
                print(f'‚ùå Error sending DM: {e}')
                return False
        
        def log_interaction(user_id, media_id, fun_fact):
            '''Log DM interaction for tracking'''
            try:
                log_entry = {
                    'timestamp': datetime.now().isoformat(),
                    'user_id': user_id,
                    'media_id': media_id,
                    'fun_fact_sent': fun_fact[:100] + '...' if len(fun_fact) > 100 else fun_fact,
                    'action': 'fun_fact_dm_sent'
                }
                
                # Simple logging to file
                log_file = 'instagram_interactions.log'
                with open(log_file, 'a') as f:
                    f.write(json.dumps(log_entry) + '\n')
                    
            except Exception as e:
                print(f'‚ö†Ô∏è Failed to log interaction: {e}')
        
        # Main execution
        instagram_account_id = get_instagram_account_id()
        
        if not instagram_account_id:
            print('‚ùå Cannot proceed without Instagram account ID')
            exit(1)
        
        # Get recent comments
        recent_comments = get_recent_comments(instagram_account_id)
        print(f'üìù Found {len(recent_comments)} recent comments')
        
        # Process comments for 'FUN FACT' trigger
        for comment in recent_comments:
            comment_text = comment.get('text', '').strip().upper()
            user_id = comment.get('from', {}).get('id')
            media_id = comment.get('media_id')
            
            print(f'üìù Processing comment: \"{comment_text}\" from user {user_id}')
            
            if comment_text == 'FUN FACT':
                # Get the fun fact for this post
                fun_fact = get_fun_fact_for_post(media_id)
                
                if fun_fact:
                    # Send DM with the fun fact
                    dm_message = f'Here\\'s your didactic fun fact: {fun_fact}'
                    
                    if send_dm(instagram_account_id, user_id, dm_message):
                        print(f'‚úÖ Sent fun fact DM to user {user_id}')
                        log_interaction(user_id, media_id, fun_fact)
                    else:
                        print(f'‚ùå Failed to send DM to user {user_id}')
                else:
                    print(f'‚ö†Ô∏è No fun fact found for media {media_id}')
            else:
                print(f'‚ÑπÔ∏è Comment doesn\\'t match trigger: \"{comment_text}\"')
        
        print('üéâ Instagram DM automation completed!')
        "
    
    - name: Commit interaction logs
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add instagram_interactions.log 2>/dev/null || true
        if git diff --staged --quiet; then
          echo "No new interactions to log"
        else
          git commit -m "üì± Log Instagram DM interactions (automated)"
          git push
        fi
